<html>
    <head>
        <title>Uno dos Gugu</title>
        <meta charset="utf8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="./css/style.css">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
        <script>
            const socket = io('http://localhost:3000');
 
            var infoUsuario = {
                apelido:    '',
                id:         '',
                conectado:  false,
                sala:       undefined,
                infoSala:   undefined
            }
 
            socket.on('connect', () => {
                console.log("Conectado ao servidor...");
            })
 
            socket.on('infoUsuario', (info) => {
                console.log("Preenchendo meus dados com recebimento do servidor...");
                let apelido = info[1];
                let id = info[0];
                infoUsuario.apelido         = apelido;
                infoUsuario.id              = id;
                infoUsuario.conectado       = true;
            })
 
            function enviaApelido() {
                let apelido = document.getElementById('apelido').value;
                if (apelido.length > 3) {
                    socket.emit('novoUsuario', apelido);
               
                document.getElementById('pseudo-login').style.display = "none";
 
                document.getElementById('enter-room').style.display = "initial";
                } else {
                    alert("Seu apelido precisa ser maior que 3 caracteres.");
                }
 
            }
 
            function salaExistente() {
                let sala = document.getElementById('idSala').value;
                socket.emit('logaSala', sala);
            }
 
            function criarSala() {
                socket.emit('criarSala', 0);
            }
 
            socket.on('entrarSala', response => {
 
                if(response.status == true) {
                    infoUsuario.sala = response.id;
                    renderSala();
                } else {
                    alert("Esta sala não existe meu casinha");
                }
 
            })
 
            socket.on('salaCriada', response => {
                console.log(response);
 
                infoUsuario.sala = response;
                renderSala();
 
            })
 
            socket.on('salaDevolvida', sala => {
                infoUsuario.infoSala = sala;
            });
 
            socket.on('jogoIniciado', (response) => {
                //console.log(response);
                if(response != false) {
                    infoUsuario.infoSala = response;
                    document.getElementById('start-game').style.display = "none";
                    document.getElementById('jogadores').style.display = 'initial';
                    document.getElementById('lista_jogadores').innerHTML = "";
                    let tempJogadores = "";
                    response.jogadores.forEach(jogador => {
                        tempJogadores += `<li> ${jogador.apelido} </li>`;
                    });
                    document.getElementById('lista_jogadores').innerHTML = tempJogadores;

                    renderizaCartas();
 
 
                   
                } else {
                    alert("Falta um casa");
                }
               
            })

            socket.on('atualizaJogo', (sala) => {
                console.log("Atualizando...")
                infoUsuario.infoSala = sala;
                renderizaCartas();
                if(minhaVez()) {
                    if(ehPossivel()) {
                        console.log("Você tem possibilidades para jogar.");
                        //socket.emit("atualizaClientes", infoUsuario.infoSala);
                    } else {
        
                        while (!ehPossivel()) {
                            //socket.emit("atualizaClientes", infoUsuario.infoSala);
                            compraCarta();
                            renderizaCartas();
                            console.log("Não pode jogar. Comprando mais...");
                            
                        }
                        
                        socket.emit("atualizaClientes", infoUsuario.infoSala);

                    }
                }
            });

            socket.on("jogoFinalizado", dadosJogador => {
                console.log(dadosJogador);
            })

            function compraCarta() {
                infoUsuario.infoSala.jogadores.forEach(jogador => {
                    if (jogador.id == infoUsuario.id) {
                        if (infoUsuario.infoSala.baralho.length > 0) {
                            jogador.cartas.push(infoUsuario.infoSala.baralho.shift());
                            
                        } else {
                            infoUsuario.infoSala.baralho = recriaBaralho(infoUsuario.infoSala.descarte);
                            jogador.cartas.push(infoUsuario.infoSala.baralho.shift());
                            
                        }
                        ///socket.emit("atualizaClientes", infoUsuario.infoSala);
                    }
                });
            }

            function recriaBaralho(baralho) {
                let copia_baralho = baralho.slice(0);
                for (let i = copia_baralho.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [copia_baralho[i], copia_baralho[j]] = [copia_baralho[j], copia_baralho[i]];
                }
                for (let i = 0; i < copia_baralho.length; i++) {
                    if (copia_baralho[i].imagem == 'p4-n' || copia_baralho[i].imagem == 'rgby') {
                        copia_baralho[i].cor = 'n';
                    }
                }
                return copia_baralho;
            }

            function ehPossivel() {
                let baralho = meuBaralho();
                let retorno = false;
                let ultimaJogada = infoUsuario.infoSala.descarte[infoUsuario.infoSala.descarte.length - 1];
                baralho.forEach(carta => {
                    if (carta.cor == 'n') {
                        retorno = true;
                    } else {
                        if (carta.cor == ultimaJogada.cor || carta.tipo == ultimaJogada.tipo) {
                            retorno = true;
                        }
                    }
                });
                return retorno;
            }
 
            function renderSala() {
                socket.emit('pedeSala', {sala: infoUsuario.sala, id_jogador: infoUsuario.id, apelido_jogador: infoUsuario.apelido});
                document.getElementById('game-room').style.display  = "initial";
                document.getElementById('enter-room').style.display = "none";
            }
 
            function iniciaJogo() {
                socket.emit('iniciaJogo', infoUsuario.sala);
            }
 

            var TEMP_POSICAO = 0;
            function jogarCarta(pos) {
                if (minhaVez()) {
                    let baralho = meuBaralho();
                    let ultimaJogada = infoUsuario.infoSala.descarte[infoUsuario.infoSala.descarte.length - 1];
                    if (baralho[pos].cor == 'n') {
                        infoUsuario.infoSala.jogador_atual = -1;
                        TEMP_POSICAO = pos;
                        document.getElementById('escolhe-cor').style.display = 'initial';
                    } else {
                        if (baralho[pos].cor == ultimaJogada.cor || baralho[pos].tipo == ultimaJogada.tipo) {
                            infoUsuario.infoSala.jogador_atual = -1;
                            socket.emit('jogarCarta', {sala: infoUsuario.sala, jogador: infoUsuario.id, carta: pos})
                            //
                        } else {
                            alert("Você não pode jogar essa carta, meu casa!");
                        }
                    }
                } else {
                    alert("Não é tua vez meu casinha.");
                }
            }

            function escolheCor(cor) {
                document.getElementById('escolhe-cor').style.display = 'none';
                socket.emit('jogarCarta', {sala: infoUsuario.sala, jogador: infoUsuario.id, carta: TEMP_POSICAO, cor: cor})
                //socket.emit("atualizaClientes", infoUsuario.infoSala);
            }

            function minhaVez() {
                if (infoUsuario.infoSala.jogadores[infoUsuario.infoSala.jogador_atual].id == infoUsuario.id) {
                    return true;
                } else {
                    return false;
                }
            }

            function meuBaralho() {
                let retorno = false;
                infoUsuario.infoSala.jogadores.forEach(jogador => {
                    if (jogador.id == infoUsuario.id) {
                        retorno =  jogador.cartas;
                    }
                });
                return retorno;
            }
 
            function renderizaCartas() {
 
                let yourCardsTemp = '<div class="cards">';
                let enemyCardsTemp = '<div class="cards">'
 
                document.getElementById('enemy-cards').innerHTML = '';
                document.getElementById('your-cards').innerHTML = '';
                document.getElementById('central-card')
                .innerHTML = `<div class="cards">    
                        <img class="c-card" src='./sliced/${infoUsuario.infoSala.descarte[infoUsuario.infoSala.descarte.length -1].imagem}.png'>
                        </div>`
                   
                   
                infoUsuario.infoSala.jogadores.forEach(jogador => {
                    let card_pos = 0;
                    if(jogador.id == infoUsuario.id) {
                        jogador.cartas.forEach(carta => {
                            yourCardsTemp += ` <img class="card" onclick='jogarCarta(${card_pos})' src="./sliced/${carta.imagem}.png">`;
                            card_pos++;
                        })
                    }
                });
 
                infoUsuario.infoSala.jogadores.forEach(jogador => {
                    if(jogador.id != infoUsuario.id) {
                        jogador.cartas.forEach(carta => {
                            enemyCardsTemp += ` <img class="card" src="./sliced/back.png">`;
                        })
                    }
                });
               
                yourCardsTemp += '</div>';
                enemyCardsTemp += '</div>';
                document.getElementById('your-cards').innerHTML = yourCardsTemp;
                document.getElementById('enemy-cards').innerHTML = enemyCardsTemp;
            }
           
 
 
        </script>
    </head>
    <body style="background-image: url('https://cdn.hipwallpaper.com/i/48/64/OR5iNS.jpg');">
        <div class="container-fluid jogadores" id="jogadores">
            <h2 align="center">JOGADORES:</h2>
            <ul id="lista_jogadores">

            </ul>
        </div>
        <div class="container-fluid escolhe-cor" id="escolhe-cor" style="">
            <h2 align=center>ESCOLHA A NOVA COR:</h2>
            <br>
            <div style="margin: 0 auto; width: fit-content; height: fit-content;">
                <button class="btn btn-success" onclick="escolheCor('g')">VERDE</button>
                <button class="btn btn-primary" onclick="escolheCor('b')">AZUL</button>
                <button class="btn btn-danger"  onclick="escolheCor('r')">VERMELHO</button>
                <button class="btn btn-warning" onclick="escolheCor('y')">AMARELO</button>
            </div>
            
        </div>
        <div class="container-fluid" id="pseudo-login">
            <div style="margin-top: 5%;"></div>
                <label for="apelido">Apelido:</label>
                <input type="text" id="apelido" class="form-control">
                <button class="btn btn-dark" onclick="enviaApelido()">ENTRAR</button>
            </div>
        </div>
 
        <div class="container-fluid" id="enter-room" style="display: none">
 
            <label for="idSala">ID da Sala:</label>
            <input type="text" id="idSala" class="form-control" style="margin-bottom: 5%;">
            <button class="btn btn-dark" onclick="salaExistente()">Sala existente</button>
            <button class="btn btn-dark" style="margin-left: 10%" onclick="criarSala()">Criar sala</button>
 
        </div>
 
        <div class="container-fluid" id="game-room" style="display: none;">
           
            <div id="enemy-cards" class="enemy-cards">
                <div class="cards">
                   
                </div>
            </div>
 
            <div id="central-card" class="central-card">
                <div class="cards">
                    <!-- <img class="c-card" src="/sliced/1-b.png"> -->
                    <button id="start-game" class="btn btn-dark" onclick="iniciaJogo()">Iniciar o Jogo</button>
                </div>
            </div>
 
            <div id="your-cards" class="your-cards">
                <div class="cards">
       
                </div>
            </div>
 
        </div>
 
   
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
    </body>
</html>